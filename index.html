<script>
    const socket = io(); // 使用 Socket.IO
    let myName = "";

    function doLogin() {
        const user = document.getElementById('user').value;
        const pass = document.getElementById('pass').value;
        if (!user || !pass) return alert('請填寫');

        // 【修正點】改用 socket 發送，不要用 fetch，因為後端沒有寫 /login API
        socket.emit('login', { u: user, p: pass });
    }

    // 登入成功
    socket.on('auth_ok', (data) => {
        myName = data.name;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('header').style.display = 'block';
        document.getElementById('chat-box').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
    });

    // 登入失敗
    socket.on('err', (msg) => alert(msg));

    // 接收訊息
    socket.on('chat message', (data) => {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${data.user === myName ? 'me' : 'other'}`;
        div.innerHTML = `<div class="user-name">${data.user}</div>${data.text}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });

    // 發送訊息
    function sendMsg() {
        const input = document.getElementById('msg-input');
        if (input.value.trim() && myName) {
            socket.emit('chat message', { text: input.value });
            input.value = '';
        }
    }

    document.getElementById('msg-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMsg();
    });
</script>
